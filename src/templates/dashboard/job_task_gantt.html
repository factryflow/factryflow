<div class="gantt bg-white p-6 rounded-lg shadow-xl">
    <h1 class="text-2xl pb-4 font-semibold text-[#181C32]">Job-Task Gantt Chart</h1>
    <!-- Loading Spinner - Moved outside scrollable container -->
    <div id="ganttLoadingForJob" class="relative inset-0 flex items-center justify-center bg-white bg-opacity-80 z-10">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#023E8A]"></div>
    </div>
    <div style="position:relative; max-height: calc(75vh - 4rem); overflow-y: auto;" id="GanttChartDIV">
        <div id="GanttChartForJob" style="position: relative;">
            <div id="ganttContent"></div>
        </div>
    </div>
</div>

<script>
    // Global variables for virtualization
    let allTasks = [];
    let ganttInstance = null;
    let isLoading = false;
    const ROW_HEIGHT = 40; // Approximate height of each task row
    const BUFFER_SIZE = 40; // Number of items to render above and below viewport
    const VIEWPORT_ITEMS = 40; // Approximate number of items visible in viewport
    let currentStartIndex = 0;
    let lastScrollTop = 0;

    // Hide loading initially since the div starts empty
    document.getElementById('ganttLoadingForJob').style.display = 'none';
    
    function initializeJobGantt() {
        var g = new JSGantt.GanttChart(document.getElementById('ganttContent'), 'day');
        ganttInstance = g;

        g.setOptions({
            vCaptionType: 'Complete',
            vQuarterColWidth: 36,
            vDateTaskDisplayFormat: 'day dd month yyyy',
            vDayMajorDateDisplayFormat: 'mon yyyy - Week ww',
            vWeekMinorDateDisplayFormat: 'dd mon',
            vLang: 'en',
            vShowTaskInfoLink: 1,
            vShowEndWeekDate: 0,
            vShowEndDate: 0,
            vShowStartDate: 0,
            vShowComp: 0,
            vShowTaskInfoComp: 0,
            vAdditionalHeaders: {
                priority: {
                    title: 'Priority'
                }
            },
            vUseSingleCell: 1000,
            vScrollTo: 'today',
            vMinGpLen: 20,
        });

        return g;
    }

    function getVisibleRange(scrollTop) {
        // Calculate the start index based on scroll position
        const estimatedStartIndex = Math.floor(scrollTop / ROW_HEIGHT);
        const startIndex = Math.max(0, estimatedStartIndex - BUFFER_SIZE);
        const endIndex = Math.min(
            allTasks.length,
            estimatedStartIndex + VIEWPORT_ITEMS + (2 * BUFFER_SIZE)
        );
        
        return { startIndex, endIndex };
    }

    function drawJobGanttChart(tasks) {
        if (isLoading) return;
        isLoading = true;

        try {
            // Clear and reinitialize
            document.getElementById('ganttContent').innerHTML = '';
            ganttInstance = initializeJobGantt();

            // Set container height for proper scrolling
            const totalHeight = allTasks.length * ROW_HEIGHT;
            document.getElementById('GanttChartForJob').style.height = `${totalHeight}px`;
            document.getElementById('ganttContent').style.position = 'absolute';
            document.getElementById('ganttContent').style.width = '100%';
            document.getElementById('ganttContent').style.top = `${currentStartIndex * ROW_HEIGHT}px`;

            // Add visible tasks
            tasks.forEach(task => {
                ganttInstance.AddTaskItemObject(task);
            });

            ganttInstance.Draw();
        } finally {
            isLoading = false;
        }
    }

    function handleGanttScroll(event) {
        if (isLoading) return;

        const container = event.target;
        const scrollTop = container.scrollTop;
        const scrollDiff = Math.abs(scrollTop - lastScrollTop);
        
        // Only process if we've scrolled at least half a row height
        if (scrollDiff < ROW_HEIGHT / 2) return;

        // Get the range of items that should be visible
        const { startIndex, endIndex } = getVisibleRange(scrollTop);
        
        // Only redraw if the visible range has changed significantly
        if (Math.abs(startIndex - currentStartIndex) >= Math.floor(BUFFER_SIZE / 2)) {
            currentStartIndex = startIndex;
            const visibleTasks = allTasks.slice(startIndex, endIndex);
            drawJobGanttChart(visibleTasks);
        }

        lastScrollTop = scrollTop;
    }

    function loadJobGanttData() {
        document.getElementById('ganttLoadingForJob').style.display = 'flex';
        isLoading = true;
        currentStartIndex = 0;
        lastScrollTop = 0;

        // Check if we have cached data in sessionStorage
        const cachedData = sessionStorage.getItem('jobGanttData');
        if (cachedData) {
            allTasks = JSON.parse(cachedData);
            const { startIndex, endIndex } = getVisibleRange(0);
            const initialTasks = allTasks.slice(startIndex, endIndex);
            drawJobGanttChart(initialTasks);
            ensureProperInitialization();
            isLoading = false;
            document.getElementById('ganttLoadingForJob').style.display = 'none';
            return;
        }

        // If no cached data, fetch from API
        axios.get(`${localStorage.getItem('API_BASE_URL')}api/job/gantt`)
            .then(response => {
                allTasks = response.data;
                // Cache the data in sessionStorage
                sessionStorage.setItem('jobGanttData', JSON.stringify(allTasks));
                const { startIndex, endIndex } = getVisibleRange(0);
                const initialTasks = allTasks.slice(startIndex, endIndex);
                drawJobGanttChart(initialTasks);
                ensureProperInitialization();
            })
            .catch(error => {
                console.error(error);
            })
            .finally(() => {
                isLoading = false;
                document.getElementById('ganttLoadingForJob').style.display = 'none';
            });
    }

    // Function to ensure proper initialization of Gantt chart dimensions
    function ensureProperInitialization() {
        // Force a reflow of the container
        const container = document.getElementById('GanttChartDIV');
        const content = document.getElementById('ganttContent');
        
        // Set initial dimensions
        if (allTasks.length > 0) {
            const totalHeight = allTasks.length * ROW_HEIGHT;
            document.getElementById('GanttChartForJob').style.height = `${totalHeight}px`;
            content.style.position = 'relative';
            content.style.width = '100%';
            content.style.top = `${currentStartIndex * ROW_HEIGHT}px`;
            
            // Force a redraw by triggering a resize event
            window.dispatchEvent(new Event('resize'));
        }
    }

    // Initial load
    loadJobGanttData();

    // Add scroll event listener with throttle for smoother performance
    document.getElementById('GanttChartDIV').addEventListener('scroll', _.throttle(handleGanttScroll, 100));

    // Listen for refresh events
    document.getElementById('jobGanttChart').addEventListener('refreshJobGantt', () => {
        // Clear session storage to force fresh data load
        sessionStorage.removeItem('jobGanttData');
        loadJobGanttData();
    });

    // Handle window resize
    window.addEventListener('resize', _.debounce(() => {
        if (!isLoading && allTasks.length > 0) {
            const container = document.getElementById('GanttChartDIV');
            const { startIndex, endIndex } = getVisibleRange(container.scrollTop);
            const visibleTasks = allTasks.slice(startIndex, endIndex);
            drawJobGanttChart(visibleTasks);
        }
    }, 100));
</script>
